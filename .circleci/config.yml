 version: 2.1

 orbs:
  win: circleci/windows@2.2.0

 jobs:
   build:
     executor: win/default     
    
     steps:
       - checkout
       - run: dotnet build --nologo -c Release
       - persist_to_workspace:
          root: .
          paths: 
            - src\Arbiter.Tests\bin\Release\net48

   test:
     executor: win/default

     steps:
        - attach_workspace:
            at: workspace
        - run: nuget install NUnit.ConsoleRunner -Version 3.11.1 -OutputDirectory .\tools
        - run: .\tools\NUnit.ConsoleRunner.3.11.1\tools\nunit3-console.exe .\workspace\src\Arbiter.Tests\bin\Release\net48\Arbiter.Tests.dll
        - store_test_results:
           path: TestResult.xml
 
 workflows:
   version: 2
   build-and-test:
     jobs:
       - build
       - test:
          requires:
           - build

   publish:
     jobs:
      - build:
          filters:
            tags:
              only: /^\d+\.\d+\.\d+$/
      - test:
          requires:
           - build
      - publish-github-release:
          requires:
          - test
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d+\.\d+\.\d+$/      